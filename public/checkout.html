<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Checkout (Mock)</title>

  <!-- Define global flags before anything else -->
  <script>
    window.adyen = false; // Will be set dynamically based on payment method type
  </script>

  <!-- Hosted fields and helper scripts -->
  <script src="js/hostedFields.js"></script>

  <script src="https://checkoutshopper-live.cdn.adyen.com/checkoutshopper/sdk/6.23.0/adyen.js"
      integrity="sha384-fwC67LcglMpjyKzY7kj0vMbD5b9MZAzsxBj4M92eh7d3vtaBa0hKdUHCUVpHeb2K"
      crossorigin="anonymous"></script>
	 
	<link rel="stylesheet"
	     href="https://checkoutshopper-live.cdn.adyen.com/checkoutshopper/sdk/6.23.0/adyen.css"
	     integrity="sha384-GQvTx/DKyDwPrqukLGTOBzAUHwXJkuUv8vwhr0ynfUapxHMCrzk84rMbd3Q/i74t"
	     crossorigin="anonymous">

  <link rel="stylesheet" href="css/checkout.css">
  <script src="js/errorModal.js"></script>
  <script src="js/apiDebugConsole.js"></script>
  <script src="js/apiWrapper.js"></script>
  <script src="js/authHelper.js"></script>
</head>

<body>
  <div class="container">
    <h1>Checkout</h1>
    <div id="result" class="summary">Loadingâ€¦</div>
    <form id="cardForm" style="display:none; margin-top:20px;">
      <div class="controls" style="display: flex; flex-direction: column; gap: 12px;">
        <label>Card Number:
          <input class="input" type="text" name="cardNumber" required maxlength="19" autocomplete="cc-number">
        </label>
        <label>Expiration:
          <input class="input" type="text" name="exp" required maxlength="7" placeholder="MM/YY" autocomplete="cc-exp">
        </label>
        <label>CVV:
          <input class="input" type="text" name="cvv" required maxlength="4" autocomplete="cc-csc">
        </label>
        <label>Cardholder Name:
          <input class="input" type="text" name="Payments::" required autocomplete="cc-name">
        </label>
        <button type="submit" class="btn">Submit Payment</button>
      </div>
    </form>
    <button id="details-btn" class="btn" style="margin-top:16px;">Show Details</button>
    <a href="index.html" class="back">&larr; Back to events</a>
  </div>

  <!-- Modal for details -->
  <div id="details-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#fff; width:70vw; min-width:320px; max-width:900px; margin:40px auto; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.12); padding:32px; position:relative;">
      <button id="close-details-modal" style="position:absolute; top:16px; right:16px; background:#ef4444; color:#fff; border:none; border-radius:6px; padding:8px 16px; font-weight:600; cursor:pointer;">Close</button>
      <h2>Details</h2>
  <div id="details-content" style="background:#f3f4f6; padding:16px; border-radius:8px; font-size:14px; max-height:60vh; overflow:auto;"></div>
    </div>
  </div>
  <script src="js/utils.js"></script>
  <script src="js/api.js"></script>
  <script src="js/dom.js"></script>
  <script src="js/adyen.js"></script>
  <script src="js/checkout.js"></script>
  <script src="js/submit.js"></script>
  <script>
    (async function() {
      // Check auth and refresh server credentials before proceeding
      if (!(await window.checkAndRefreshAuth())) {
        return; // Will redirect to login
      }

      try {
        /*
          When we load the page, we can be in two situations:
          1. Normal checkout flow: user just landed on checkout.html to start payment
          2. 3DS flow returning from issuer: user is returning from the bank's authentication page with URL parameters
             that we need to handle to complete the payment.
          In case 2, we need to handle the URL parameters first before proceeding with the checkout orchestration.
        */
        var localStoragePaymentID = localStorage.getItem('paymentID');
        var result = handleUrlParameters(localStoragePaymentID);
        // handleUrlParameters may return a promise or a sync value
        if (result && typeof result.then === 'function') result = await result;
        if (result && typeof result.then === 'function') {
          // defensive: if it still returns a promise, await it
          result = await result;
        }
        // kick off orchestrator after helper scripts are loaded
        if (typeof window.doCheckout === 'function' && !(result && result.urlHandled)) window.doCheckout();
      } catch (e) {
        console.error('Error handling URL parameters:', e);
        if (typeof window.doCheckout === 'function') window.doCheckout();
      }
    })();
  </script>
</body>
</html>
