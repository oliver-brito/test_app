<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Checkout (Mock)</title>

  <!-- Define global flags before anything else -->
  <script>
    window.adyen = false; // Will be set dynamically based on payment method type
  </script>

  <!-- Hosted fields and helper scripts -->
  <script src="hostedFields.js"></script>

  <script src="https://checkoutshopper-live.cdn.adyen.com/checkoutshopper/sdk/6.23.0/adyen.js"
      integrity="sha384-fwC67LcglMpjyKzY7kj0vMbD5b9MZAzsxBj4M92eh7d3vtaBa0hKdUHCUVpHeb2K"
      crossorigin="anonymous"></script>
	 
	<link rel="stylesheet"
	     href="https://checkoutshopper-live.cdn.adyen.com/checkoutshopper/sdk/6.23.0/adyen.css"
	     integrity="sha384-GQvTx/DKyDwPrqukLGTOBzAUHwXJkuUv8vwhr0ynfUapxHMCrzk84rMbd3Q/i74t"
	     crossorigin="anonymous">

  <style>
    body { font-family: system-ui, sans-serif; background: #fafafa; margin: 0; padding: 0; }
    .container { max-width: 600px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 32px; }
    h1 { font-size: 2rem; margin-bottom: 24px; }
    .summary { margin-bottom: 24px; }
    .label { font-weight: 600; }
    .value { margin-left: 8px; }
    .success { color: #16a34a; font-weight: 600; }
    .error { color: #b91c1c; font-weight: 600; }
    .back { display: inline-block; margin-top: 24px; color: #2563eb; text-decoration: none; }

    form label { 
      display: block; 
      font-weight: 600; 
      margin-top: 16px; 
      margin-bottom: 6px;
      color: #374151;
      font-size: 14px;
    }

    .hosted-field { 
      border: 1px solid #d1d5db; 
      border-radius: 6px; 
      padding: 12px; 
      background: #fff;
      min-height: 20px;
      width: 100%;
      box-sizing: border-box;
      transition: border-color 0.15s ease-in-out;
    }

    .hosted-field:focus-within {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn { 
      background: #3b82f6; 
      color: white; 
      border: none; 
      padding: 12px 24px; 
      border-radius: 6px; 
      cursor: pointer; 
      font-weight: 600;
      font-size: 16px;
      margin-top: 24px;
      width: 100%;
      transition: background-color 0.15s ease-in-out;
    }

    .btn:hover { background: #2563eb; }
    .btn:disabled { background: #9ca3af; cursor: not-allowed; }

    .adyen-dropin { margin-top: 24px; max-width: 100%; }
    .adyen-dropin .adyen-checkout__payment-method { margin-bottom: 16px; }
  </style>
</head>

<body>
  <div class="container">
    <h1>Checkout</h1>
    <div id="result" class="summary">Loadingâ€¦</div>
    <form id="cardForm" style="display:none; margin-top:20px;">
      <div class="controls" style="display: flex; flex-direction: column; gap: 12px;">
        <label>Card Number:
          <input class="input" type="text" name="cardNumber" required maxlength="19" autocomplete="cc-number">
        </label>
        <label>Expiration:
          <input class="input" type="text" name="exp" required maxlength="7" placeholder="MM/YY" autocomplete="cc-exp">
        </label>
        <label>CVV:
          <input class="input" type="text" name="cvv" required maxlength="4" autocomplete="cc-csc">
        </label>
        <label>Cardholder Name:
          <input class="input" type="text" name="Payments::" required autocomplete="cc-name">
        </label>
        <button type="submit" class="btn">Submit Payment</button>
      </div>
    </form>
    <button id="details-btn" class="btn" style="margin-top:16px;">Show Details</button>
    <a href="index.html" class="back">&larr; Back to events</a>
  </div>

  <!-- Modal for details -->
  <div id="details-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#fff; width:70vw; min-width:320px; max-width:900px; margin:40px auto; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.12); padding:32px; position:relative;">
      <button id="close-details-modal" style="position:absolute; top:16px; right:16px; background:#ef4444; color:#fff; border:none; border-radius:6px; padding:8px 16px; font-weight:600; cursor:pointer;">Close</button>
      <h2>Details</h2>
  <div id="details-content" style="background:#f3f4f6; padding:16px; border-radius:8px; font-size:14px; max-height:60vh; overflow:auto;"></div>
    </div>
  </div>
  <script>
    // Details button logic
    document.addEventListener('DOMContentLoaded', function() {
      const detailsBtn = document.getElementById('details-btn');
      const detailsModal = document.getElementById('details-modal');
      const detailsContent = document.getElementById('details-content');
      const closeModalBtn = document.getElementById('close-details-modal');

      // Helper: Render foldable JSON
      function renderFoldableJSON(obj, parent) {
        if (typeof obj !== 'object' || obj === null) {
          const leaf = document.createElement('span');
          leaf.textContent = JSON.stringify(obj);
          parent.appendChild(leaf);
          return;
        }
        const isArray = Array.isArray(obj);
        const container = document.createElement('div');
        container.style.marginLeft = '16px';
        for (const key in obj) {
          if (!obj.hasOwnProperty(key)) continue;
          const item = document.createElement('div');
          item.style.marginBottom = '2px';
          const toggle = document.createElement('span');
          toggle.textContent = isArray ? `[${key}]` : key;
          toggle.style.fontWeight = 'bold';
          toggle.style.cursor = 'pointer';
          toggle.style.color = '#2563eb';
          toggle.style.marginRight = '8px';
          const value = obj[key];
          const childContainer = document.createElement('div');
          childContainer.style.display = 'none';
          childContainer.style.marginLeft = '16px';
          toggle.onclick = function() {
            childContainer.style.display = childContainer.style.display === 'none' ? 'block' : 'none';
          };
          item.appendChild(toggle);
          if (typeof value === 'object' && value !== null) {
            item.appendChild(document.createTextNode(': '));
            item.appendChild(childContainer);
            renderFoldableJSON(value, childContainer);
          } else {
            item.appendChild(document.createTextNode(': ' + JSON.stringify(value)));
          }
          container.appendChild(item);
        }
        parent.appendChild(container);
      }

      if (detailsBtn) {
        detailsBtn.onclick = async function() {
          try {
            console.log('Fetching details...');
            const r = await fetch('/details');
            const data = await r.json();
            detailsContent.innerHTML = '';
            renderFoldableJSON(data, detailsContent);
            detailsModal.style.display = 'flex';
          } catch (err) {
            detailsContent.innerHTML = '<span style="color:#b91c1c">Error fetching details: ' + err.message + '</span>';
            detailsModal.style.display = 'flex';
          }
        };
      }
      if (closeModalBtn) {
        closeModalBtn.onclick = function() {
          detailsModal.style.display = 'none';
        };
      }
    });

    async function doCheckout() {
      const deliveryMethod = localStorage.getItem('deliveryMethod') || '';
      const paymentMethod = localStorage.getItem('paymentMethod') || '';
      const eventId = localStorage.getItem('eventId') || '';
      const resultDiv = document.getElementById('result');
      try {
        const r = await fetch('/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ eventId, deliveryMethod, paymentMethod })
        });
        const data = await r.json();
        const payment_details = data.payment_details || {};
        console.log(payment_details);
        let pa_request_url = payment_details.pa_request_URL?.standard || '';
        let conversationToken = payment_details.server_to_client_token?.standard || '';
        let paymentID = payment_details.payment_id?.standard || '';
        window.paymentID = paymentID;

        // Check payment method type and set adyen flag
        if (paymentID) {
          try {
            const paymentTypeResponse = await fetch('/getPaymentMethodType', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ paymentID: paymentID })
            });
            const paymentTypeData = await paymentTypeResponse.json();
            console.log('Payment method type response:', paymentTypeData);
            
            if (paymentTypeData.success && paymentTypeData.paymentMethodType) {
              const paymentMethodType = paymentTypeData.paymentMethodType;
              // Check if any field contains "adyen" (case-insensitive)
              const containsAdyen = Object.values(paymentMethodType).some(value => 
                typeof value === 'string' && value.toLowerCase().includes('adyen')
              );
              window.adyen = containsAdyen;
              console.log('Payment method type contains Adyen:', containsAdyen, paymentMethodType);
            } else {
              console.warn('Failed to get payment method type, defaulting adyen to false');
              window.adyen = false;
            }
          } catch (error) {
            console.warn('Error checking payment method type:', error, 'defaulting adyen to false');
            window.adyen = false;
          }
        }

        // Allow override via prompt (for dev/debug)
        if (window.location.hash.includes('override')) {
          const overrideToken = prompt('Override conversation token? Leave blank to use default.', conversationToken);
          if (overrideToken) conversationToken = overrideToken;
          const overridePaymentID = prompt('Override paymentID? Leave blank to use default.', paymentID);
          if (overridePaymentID) {
            paymentID = overridePaymentID;
            window.paymentID = paymentID;
          }
        }

        // Function to render shared checkout info
        function renderSharedInfo() {
          return `
            <div class="label">Event ID:</div><div class="value">${eventId}</div>
            <div class="label">Delivery Method:</div><div class="value">${deliveryMethod}</div>
            <div class="label">Payment Method:</div><div class="value">${paymentMethod}</div>
            <div class="label">PA Request URL:</div><div class="value"><a href="${pa_request_url}" target="_blank">${pa_request_url}</a></div>
            <div class="label">Conversation Token:</div><div class="value" id="conv-token-value">${conversationToken}</div>
            <div class="label">Payment ID:</div><div class="value" id="payment-id-value">${paymentID}</div>
            <button type="button" class="btn" id="change-info-btn" style="margin-bottom:16px; width:auto;">Change Info</button>
          `;
        }

        // Function to get payment configuration
        async function getPaymentConfiguration() {
          try {
            // Get current payment context
            const paymentMethodId = localStorage.getItem('paymentMethod') || '';
            const eventId = localStorage.getItem('eventId') || '';
            
            // Fetch configuration from server
            const response = await fetch('/getPaymentClientConfig', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                paymentMethodId: paymentMethodId,
                eventId: eventId,
                paymentID: window.paymentID
              })
            });
            const serverConfig = await response.json();
            console.log('Server payment config:', serverConfig);
            
            // Use server config if available, otherwise fall back to defaults
            return {
              environment: serverConfig.environment || 'test',
              clientKey: serverConfig.clientKey || 'test_7REK4YQWRZB2DPRS7RNTFTGX2MPKY4SQ',
              countryCode: serverConfig.countryCode || 'US',
              currency: serverConfig.currency || 'USD'
            };
          } catch (error) {
            console.warn('Failed to fetch payment config from server, using defaults:', error);
            // Fallback to default configuration
            return {
              environment: 'test', // 'test' or 'live'
              clientKey: 'test_7REK4YQWRZB2DPRS7RNTFTGX2MPKY4SQ', // Your client key
              countryCode: 'US',
              currency: 'USD'
            };
          }
        }

        // Function to get payment response (if needed)
        async function getPaymentResponse() {
          try {
            const response = await fetch('/getPaymentResponse', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                paymentID: window.paymentID
              })
            });
            const paymentResponse = await response.json();
            console.log('Payment response from server:', paymentResponse);
            return paymentResponse;
          } catch (error) {
            console.warn('Failed to fetch payment response from server:', error);
            return null;
          }
        }

        // Function to handle Adyen payment submission
        async function handleAdyenSubmit(state, dropin) {
          console.log('Adyen Drop-in onSubmit:', state);
          try {
            // Send payment data to server for processing
            const response = await fetch('/processAdyenPayment', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                externalData: JSON.stringify(state.data),
                paymentID: window.paymentID
              })
            });
            const result = await response.json();
            console.log('Payment processing result:', result);
            
            if (result.success && result.redirectUrl) {
              // Redirect to confirmation page
              window.location.href = result.redirectUrl;
            } else if (result.paRequestInfo) {
              // Handle additional action (3D Secure, etc.)
              console.log('Handling additional action with paRequestInfo:', result.paRequestInfo);
              dropin.handleAction(result.paRequestInfo);
              console.log('Called dropin.handleAction with paRequestInfo');
            } else {
              throw new Error(result.error || 'Payment failed');
            }
          } catch (error) {
            console.error('Payment submission error:', error);
            alert('Payment submission failed: ' + error.message);
          }
        }

        async function renderAdyenDropIn() {
          const paymentConfig = await getPaymentConfiguration();
          const paymentResponse = await getPaymentResponse();
          
          // Render Adyen Drop-in
          const adyenContainer = document.createElement('div');
          adyenContainer.id = 'adyen-dropin-container';
          adyenContainer.className = 'adyen-dropin';
          resultDiv.appendChild(adyenContainer);

          try {
            // Use real payment methods from AudienceView if available, otherwise fallback to mock
            let paymentMethodsResponse;
            
            if (paymentResponse && paymentResponse.success && paymentResponse.paymentMethodsResponse) {
              console.log('Using real payment methods from AudienceView:', paymentResponse.paymentMethodsResponse);
              paymentMethodsResponse = paymentResponse.paymentMethodsResponse;
            } else {
              console.warn('No payment response available, using fallback payment methods');
              paymentMethodsResponse = {
                paymentMethods: [
                  {
                    name: 'Credit Card',
                    type: 'scheme'
                  },
                  {
                    name: 'PayPal',
                    type: 'paypal'
                  }
                ]
              };
            }

            // Initialize Adyen Drop-in with real or fallback configuration
            const configuration = {
              environment: paymentConfig.environment,
              clientKey: paymentConfig.clientKey,
              countryCode: paymentConfig.countryCode,
              paymentMethodsResponse: paymentMethodsResponse,
              amount: {
                value: Math.round(parseFloat(window.orderTotal || '0') * 100), // Amount in cents
                currency: paymentConfig.currency
              },
              onSubmit: (state, dropin) => {
                handleAdyenSubmit(state, dropin);
              },
              onAdditionalDetails: (state, dropin) => {
                console.log('Adyen Drop-in onAdditionalDetails:', state);
              },
              onError: (error, dropin) => {
                console.error('Adyen Drop-in error:', error);
                alert('Payment error: ' + error.message);
              },
              onLoad: (state, dropin) => {
                console.log('Adyen Drop-in loaded');
                //call /checkPaResponseInformation
              }
            };
            const { AdyenCheckout, Dropin, Card, GooglePay, PayPal  } = window.AdyenWeb;
            // Expose Adyen Checkout and Dropin instances as globals so other scripts can access them
            window.adyenCheckout = await AdyenCheckout(configuration);
            const checkout = window.adyenCheckout;
            // Payment method specific configuration must be passed to the Dropin (not the core)
            const dropinOptions = {
              paymentMethodsConfiguration: {
                card: {
                  hasHolderName: true,
                  holderNameRequired: true,
                  billingAddressRequired: true
                }
              }
            };
            // Expose dropin globally for debugging and external control
            window.adyenDropin = new Dropin(checkout, dropinOptions);
            window.adyenDropin.mount('#adyen-dropin-container');
          }catch (err) {
            console.error('Error initializing Adyen Drop-in:', err);
            resultDiv.innerHTML += `<div class="error">Error initializing Adyen Drop-in: ${err.message}</div>`;
          }
        }

        // Render checkout info and add Change Info button
        function renderCheckoutInfo() {
          if (window.adyen) {
            // Render only basic info for Adyen, no payment form
            resultDiv.innerHTML = renderSharedInfo();
          } else {
            // Render full form for hosted fields
            resultDiv.innerHTML = renderSharedInfo() + `
              <form id="payment-form" method="post" action="process_payment" style="margin-top:24px;">
                <h3>Payment Details</h3>
                <label for="account_number-container">Account Number:</label>
                <div id="account_number-container" class="hosted-field"></div>
                <label for="cvv-container">CVV:</label>
                <div id="cvv-container" class="hosted-field"></div>
                <label for="exp_date-container">Expiration Date:</label>
                <div id="exp_date-container" class="hosted-field"></div>
                <label for="cardholder_name-container">Cardholder Name:</label>
                <input 
                  type="text" 
                  name="BOset::BOorder::Payments::${paymentID}::cardholder_name" 
                  maxlength="100" 
                  class="input form-control" 
                  value="" 
                  title="Cardholder Name" 
                  id="BOset::BOorder::Payments::${paymentID}::cardholder_name" 
                  required 
                  autocomplete="cc-name">
                <button type="submit" class="btn" id="submit-button" onClick="handleSubmit(event)">Submit Payment</button>
              </form>
            `;
          }
        }

        // Function to (re)initialize hosted fields
        function initHostedFields() {
          if (window.HostedFieldsManager) {
            const hostedFieldsManager = new window.HostedFieldsManager();
            window.currentHostedFieldsManager = hostedFieldsManager;
            hostedFieldsManager.initializeHostedFields({
              conversationToken: conversationToken,
              paRequestUrl: pa_request_url,
              resultContainer: resultDiv,
              onStatusUpdate: (fieldName, status, allStatuses) => {
                console.log(`Field ${fieldName} status:`, status);
                console.log('All field statuses:', allStatuses);
                const allValid = Object.values(allStatuses).every(s => s && s.isValid);
                if (allValid) {
                  console.log('ðŸŽ‰ All payment fields are now valid!');
                }
              },
              onError: (error) => {
                console.error('Hosted fields error:', error);
              }
            });
          } else {
            resultDiv.innerHTML += `<div class="error">Hosted fields module not loaded. Please refresh the page.</div>`;
          }
        }

        // Initial render and init
        renderCheckoutInfo();
        
        // Choose payment rendering based on adyen flag
        if (window.adyen) {
          // create Adyen Drop-in mount
          const adyenContainer = document.createElement('div');
          adyenContainer.id = 'adyen-dropin-container';
          resultDiv.appendChild(adyenContainer);
          renderAdyenDropIn();
        } else {
          initHostedFields();
        }

        // Add Change Info button logic
        document.getElementById('change-info-btn').onclick = function() {
          const newToken = prompt('Override conversation token? Leave blank to use current.', conversationToken);
          if (newToken !== null && newToken !== '') {
            conversationToken = newToken;
          }
          const newPaymentID = prompt('Override paymentID? Leave blank to use current.', paymentID);
          if (newPaymentID !== null && newPaymentID !== '') {
            paymentID = newPaymentID;
            window.paymentID = paymentID;
          }
          // Re-render and re-init
          renderCheckoutInfo();
          if (window.adyen) {
            renderAdyenDropIn();
          } else {
            initHostedFields();
          }
        };
      } catch (err) {
        resultDiv.innerHTML = `<div class="error">Checkout failed: ${err.message}</div>`;
      }
    }

    // Call doCheckout safely from non-module script: wrap in an async IIFE
    (async function() {
      try {
        const result = doCheckout();
        // Ensure we handle both Promise and non-Promise returns
        if (result && typeof result.then === 'function') {
          await result;
        }
        console.log('Checkout process completed.');
        // Call 3DS response processing after checkout completes
        processThreeDSResponse();
      } catch (err) {
        console.error('Error during checkout:', err);
        // Still attempt to process 3DS response in case redirect params are present
        try { processThreeDSResponse(); } catch (e) { /* ignore */ }
      }
    })();

    // If the URL contains resultCode and redirectResult, POST them to server endpoint for 3DS processing.
    async function processThreeDSResponse() {
      try {
        const params = new URLSearchParams(window.location.search);
        const paramsString = params.toString(); // e.g. "resultCode=...&redirectResult=..."
        if (!paramsString) return;

        // Send to server endpoint for processing: send full params string and paymentID
        const paymentID = window.paymentID || '';
        const payload = { params: paramsString, paymentID };
        const r = await fetch('/processThreeDSResponse', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        let json;
        try { json = await r.json(); } catch (e) { json = null; }

        if (!r.ok) {
          console.warn('/processThreeDSResponse failed', r.status, json);
          alert('3DS processing failed on server: ' + (json?.error || r.status));
          return;
        }

        // Show simple feedback to the user
        if (json && json.success) {
          alert('3DS processed: ' + (json.message || 'success'));
          // Optionally redirect if server instructs
          if (json.redirectUrl) window.location.href = json.redirectUrl;
        } else {
          alert('3DS processing response: ' + JSON.stringify(json));
        }
      } catch (err) {
        console.warn('Error in processThreeDSResponse', err);
      }
    }

  // NOTE: processThreeDSResponse() is invoked after checkout completes where paymentID is available.

    function handleSubmit(event) {
      event.preventDefault();
      
      const submitButton = document.getElementById('submit-button');
      const resultDiv = document.getElementById('result');
      
      console.log('=== SUBMIT FUNCTION STARTED ===');
      console.log('AvHostedInputSDK available:', typeof AvHostedInputSDK !== 'undefined');
      console.log('AvHostedInputSDK object:', AvHostedInputSDK);
      
      // Disable submit button to prevent double submission
      submitButton.disabled = true;
      submitButton.textContent = 'Processing...';
      
      // Check if AvHostedInputSDK is available
      if (typeof AvHostedInputSDK === 'undefined') {
        console.error('AvHostedInputSDK is undefined');
        showError('Payment system not loaded. Please refresh the page and try again.');
        return;
      }

      // Check if submitGroup method exists
      if (typeof AvHostedInputSDK.submitGroup !== 'function') {
        console.error('AvHostedInputSDK.submitGroup is not a function:', typeof AvHostedInputSDK.submitGroup);
        showError('Payment submission method not available. Please refresh the page.');
        return;
      }

      console.log('About to call AvHostedInputSDK.submitGroup()...');
      
      // Try calling submitGroup with more detailed error handling
      try {
        const paymentID = window.paymentID || '';
        const submitPromise = AvHostedInputSDK.submitGroup();
        console.log('submitGroup() called, returned:', submitPromise);
        console.log('Is it a Promise?', submitPromise instanceof Promise);

        function showProcessButton(paymentData, paymentID) {
          // Remove any previous button
          const oldBtn = document.getElementById('manual-process-btn');
          if (oldBtn) oldBtn.remove();

          const resultDiv = document.getElementById('result');
          const btn = document.createElement('button');
          btn.id = 'manual-process-btn';
          btn.className = 'btn';
          btn.textContent = 'Continue to Process Transaction';
          btn.style.marginTop = '20px';
          btn.onclick = async function() {
            btn.disabled = true;
            btn.textContent = 'Processing...';
            await processTransaction(paymentData, paymentID);
          };
          resultDiv.appendChild(btn);
        }

        if (submitPromise && typeof submitPromise.then === 'function') {
          // It's a Promise
          submitPromise.then((paymentData) => {
            console.log('=== AvHostedInputSDK.submitGroup() Promise Resolved ===');
            console.log('Resolved Promise:', submitPromise);
            
            showProcessButton(paymentData, paymentID);

          }).catch((error) => {
            console.error('=== AvHostedInputSDK.submitGroup() Promise Rejected ===');
            console.error('Error:', error);
            console.error('Error type:', typeof error);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            showError(`Payment submission failed: ${error.message}`);
          });
        } else {
          // It's not a Promise, handle synchronously
          console.log('submitGroup() returned synchronously:', submitPromise);
          showProcessButton(submitPromise, paymentID);
        }
      } catch (syncError) {
        console.error('=== Synchronous Error in submitGroup() ===');
        console.error('Error:', syncError);
        console.error('Error message:', syncError.message);
        showError(`Payment submission error: ${syncError.message}`);
      }
      
  async function processTransaction(paymentData, paymentID) {
        try {
          console.log('=== PROCESSING TRANSACTION ===');
          // Call the transaction endpoint
          const transactionResponse = await fetch('/transaction', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              paymentData: paymentData,
              paymentID: paymentID,
              orderData: {
            eventId: localStorage.getItem('eventId'),
            deliveryMethod: localStorage.getItem('deliveryMethod'),
            paymentMethod: localStorage.getItem('paymentMethod'),
            eventName: localStorage.getItem('eventName'),
            eventDate: localStorage.getItem('eventDate')
              }
            })
          });

          console.log('Transaction response status:', transactionResponse.status);
          const transactionResult = await transactionResponse.json();
          console.log('Transaction result:', transactionResult);
          
          if (transactionResult.success && transactionResult.redirectUrl) {
            // Show success message briefly before redirect
            showSuccess('Payment processed successfully! Redirecting to confirmation...');
            
            // Redirect to order confirmation page
            setTimeout(() => {
              window.location.href = transactionResult.redirectUrl;
            }, 1500);
            
          } else {
            throw new Error(transactionResult.error || 'Transaction failed');
          }

        } catch (error) {
          console.error('Transaction error:', error);
          showError(`Transaction failed: ${error.message}`);
        }
      }
      
      function showError(message) {
        submitButton.disabled = false;
        submitButton.textContent = 'Submit Payment';
        
        // Remove any existing error messages
        const existingErrors = resultDiv.querySelectorAll('.payment-error');
        existingErrors.forEach(error => error.remove());
        
        // Add new error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error payment-error';
        errorDiv.style.marginTop = '16px';
        errorDiv.textContent = message;
        resultDiv.appendChild(errorDiv);
      }
      
      function showSuccess(message) {
        // Remove any existing messages
        const existingMessages = resultDiv.querySelectorAll('.payment-error, .payment-success');
        existingMessages.forEach(msg => msg.remove());
        
        // Add success message
        const successDiv = document.createElement('div');
        successDiv.className = 'success payment-success';
        successDiv.style.marginTop = '16px';
        successDiv.textContent = message;
        resultDiv.appendChild(successDiv);
      }
    }
  </script>
</body>
</html>
