<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Event Details</title>
  <script src="helpers.js"></script>
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    body { margin: 16px; background: #fafafa; }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { font-size: 1.75rem; margin: 0 0 16px; }
    .row { display: flex; gap: 16px; align-items: flex-start; margin-bottom: 16px; }
    .thumb { width: 320px; height: 200px; object-fit: cover; border-radius: 8px; background: #e5e7eb; }
    .muted { color: #6b7280; margin: 4px 0; }
    .controls { display: flex; gap: 8px; align-items: center; margin: 20px 0; }
    .input { width: 100px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px; }
    .btn { appearance: none; background: #3b82f6; color: #fff; border: 0; border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer; }
    .btn-secondary { background: #16a34a; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .seats { list-style: none; padding: 0; display: grid; gap: 10px; }
    .seat { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #e5e7eb; border-radius: 10px; background: #fff; }
    .error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; padding: 10px; border-radius: 8px; margin: 10px 0; }
    a.link { color: #2563eb; text-decoration: none; }
  </style>
</head>
<body>
  <div class="container">
    <a class="link" href="index.html">← Back to events</a>
    <h1 id="title">Loading…</h1>

    <div id="error" class="error" style="display:none;"></div>

    <div class="row">
      <img id="image" class="thumb" alt="Event image" src="av.webp" />
      <div>
        <p id="desc" class="muted"></p>
        <p class="muted"><strong>Start:</strong> <span id="start">—</span></p>
        <p class="muted"><strong>End:</strong> <span id="end">—</span></p>
        <p class="muted"><strong>Venue:</strong> <span id="venue">—</span></p>
        <p class="muted"><strong>City:</strong> <span id="city">—</span></p>
        <p class="muted"><strong>Availability:</strong> <span id="avail">—</span></p>
        <p class="muted"><strong>Price:</strong> <span id="price">—</span></p>
      </div>
    </div>

    <div class="controls">
      <label for="num">People:</label>
      <input id="num" class="input" type="number" min="1" value="1"/>
      <label for="pricetype">Price Type:</label>
      <select id="pricetype" class="input"></select>
      <input id="pricetype_value" type="hidden" />
      <button id="best" class="btn">Get Seats & Add</button>
      <a id="checkout" class="btn btn-secondary" href="checkout.html" style="display:none;">Checkout</a>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px;">Selected seats</h3>
      <ul id="seats" class="seats"></ul>
    </div>
  </div>

  <script>
    const $title = document.getElementById("title");
    const $image = document.getElementById("image");
    const $desc  = document.getElementById("desc");
    const $start = document.getElementById("start");
    const $end   = document.getElementById("end");
    const $venue = document.getElementById("venue");
    const $city  = document.getElementById("city");
    const $avail = document.getElementById("avail");
    const $price = document.getElementById("price");
    const $error = document.getElementById("error");
    const $seats = document.getElementById("seats");
    const $num   = document.getElementById("num");
    const $pricetype = document.getElementById("pricetype");
    const $pricetype_value = document.getElementById("pricetype_value");
    const $best  = document.getElementById("best");
    const $checkout = document.getElementById("checkout");

    const params = new URLSearchParams(location.search);
    const eventId = params.get("id");

    // ...helpers.js now provides: fallbackImage, showError, parseMoney, pricingMinMax, avText, avImg...

    function renderEvent(ev) {
      // Title (prefer short_description if present)
      $title.textContent = avText(ev.short_description) || avText(ev.name) || "Untitled event";

      // Image (fallback chain since there's no image1 here)
      const imgSrc = avImg(ev.logo1, ev.alternative_overview_image, ev.thumbnail, ev.app_image);
      $image.src = fallbackImage(imgSrc);

      // Description
      $desc.textContent = avText(ev.description) || "";

      // Dates (handle arrays in display)
      $start.textContent = avText(ev.start_date) || "—";
      $end.textContent   = avText(ev.end_date)   || "—";

      // Venue (performance payload has venue_short_description, not venue_name)
      $venue.textContent = avText(ev.venue_short_description) || "—";

      // City not provided by performance.load
      $city.textContent = "—";

      // Price range not provided here
      $price.textContent = "—";

      // Availability: use total_seats as a coarse indicator (no live availability here)
      $avail.textContent = avText(ev.total_seats) || "—";
    }


    function renderSeats(list) {
      $seats.innerHTML = "";
      if (!list || list.length === 0) {
        $seats.insertAdjacentHTML("beforeend", `<li class="muted">No seats selected yet.</li>`);
        return;
      }
      for (const s of list) {
        const li = document.createElement("li");
        li.className = "seat";
        li.innerHTML = `
          <div>
            <div><strong>Row:</strong> ${s.row?.standard ?? "—"}</div>
            <div><strong>Seat:</strong> ${s.seat?.standard ?? "—"}</div>
            <div><strong>Aisle:</strong> ${s.aisle?.standard ?? "—"}</div>
          </div>
          <div><strong>${s.net?.display ?? "—"}</strong></div>
        `;
        $seats.appendChild(li);
      }
    }

    async function loadEvent() {
      if (!eventId) {
        showError("Missing event id.");
        return;
      }
      try {
        const r = await fetch(`/events/${encodeURIComponent(eventId)}`);
        if (!r.ok) throw new Error("Failed to load event");
        const ev = await r.json();
        renderEvent(ev);
        console.log("Event loaded:", ev);
      } catch (e) {
        console.error(e);
        showError("Couldn't load event. Please try again.");
      }
    }

    async function getBestAvailable() {
      const n = Math.max(1, parseInt($num.value, 10) || 1);
      const priceTypeId = $pricetype.value;
      try {
        const r = await fetch(`/map/availability/${encodeURIComponent(eventId)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ numSeats: n, priceTypeId })
        });
        if (!r.ok) throw new Error("Failed to load availability");
        const data = await r.json();
        console.log("Best available loaded:", data);

        // Admissions (seats)
        const admissions = data?.data?.Admissions || {};
        const seatRows = Object.entries(admissions)
          .filter(([k]) => k !== "state")
          .map(([, v]) => v);
        const pseudoSeats = seatRows.map((row) => ({
          row: { standard: row?.row?.standard ?? "—" },
          seat: { standard: row?.seat?.standard ?? "—" },
          aisle: { standard: row?.aisle?.standard ?? "—" },
          net: { display: row?.net?.display ?? "" }
        }));
        renderSeats(pseudoSeats);
        $checkout.style.display = "";

        // Render Delivery Methods dropdown
        let $delivery = document.getElementById("delivery");
        if (!$delivery) {
          $delivery = document.createElement("select");
          $delivery.id = "delivery";
          $delivery.className = "input";
          $delivery.style.marginLeft = "10px";
          $checkout.parentNode.insertBefore($delivery, $checkout);
        }
        $delivery.innerHTML = "";
        const delivery = data?.data?.DeliveryMethodDetails || {};
        Object.entries(delivery).forEach(([id, d]) => {
          if (id === "state") return;
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = d?.name?.display || d?.name?.standard || id;
          $delivery.appendChild(opt);
        });

        // Render Payment Methods dropdown
        let $payment = document.getElementById("payment");
        if (!$payment) {
          $payment = document.createElement("select");
          $payment.id = "payment";
          $payment.className = "input";
          $payment.style.marginLeft = "10px";
          $delivery.parentNode.insertBefore($payment, $delivery.nextSibling);
        }
        $payment.innerHTML = "";
        const payment = data?.data?.AvailablePaymentMethods || {};
        Object.entries(payment).forEach(([id, p]) => {
          if (id === "state") return;
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = p?.name?.display || p?.name?.standard || id;
          $payment.appendChild(opt);
        });
      } catch (e) {
        console.error(e);
        showError("Couldn't load availability. Please try again.");
      }
    }

    // Fetch price types from /map/pricing/:id and populate dropdown
    async function populatePriceTypes() {
      console.log("Loading price types for event:", eventId);
      $pricetype.innerHTML = '';
      if (!eventId) return;
      try {
        const r = await fetch(`/map/pricing/${encodeURIComponent(eventId)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({})
        });
        if (!r.ok) throw new Error("Failed to load price types");
        const data = await r.json();
        console.log("Price types loaded:", data);
        const pricetypes = data.pricetypes;
        if (pricetypes && typeof pricetypes === "object") {
          Object.entries(pricetypes).forEach(([id, pt]) => {
            if (id === "state") return;
                const name = pt?.name?.display || pt?.name?.standard || id;
                const opt = document.createElement("option");
                opt.value = id;
                opt.textContent = name;
                $pricetype.appendChild(opt);
          });
        }
        $pricetype_value.value = $pricetype.value || "";
      } catch (e) {
        showError("Couldn't load price types. Please try again.");
      }
    }

    $pricetype.addEventListener("change", function() {
      $pricetype_value.value = $pricetype.value;
    });

    $best.addEventListener("click", getBestAvailable);

    // Mock checkout handler

    $checkout.addEventListener("click", function(e) {
      e.preventDefault();
      const $delivery = document.getElementById("delivery");
      const $payment = document.getElementById("payment");
      const deliveryMethod = $delivery ? $delivery.value : null;
      const paymentMethod = $payment ? $payment.value : null;
      if (!deliveryMethod || !paymentMethod) {
        showError("Please select a delivery and payment method.");
        return;
      }
      // Save to localStorage for checkout.html to read
      localStorage.setItem('deliveryMethod', deliveryMethod);
      localStorage.setItem('paymentMethod', paymentMethod);
      localStorage.setItem('eventId', eventId);
      window.location.href = "checkout.html";
    });

    loadEvent();
    renderSeats([]); // initial
    populatePriceTypes();
  </script>
</body>
</html>
