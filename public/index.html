<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Upcoming Events</title>
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    body { margin: 16px; background: #fafafa; }
    h1 { font-size: 1.75rem; margin: 0 0 16px; }
    .events { list-style: none; padding: 0; margin: 0; display: grid; gap: 12px; }
    .card { display: flex; gap: 12px; align-items: center; background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .thumb { width: 25%; max-width: 220px; height: 160px; object-fit: cover; border-radius: 8px; background: #f3f4f6; }
    .meta { flex: 1; min-width: 0; }
    .title { font-weight: 600; font-size: 1.125rem; margin: 0 0 4px; }
    .muted { color: #6b7280; margin: 2px 0; }
    .badge { display: inline-flex; align-items: center; background: #ecfdf5; color: #065f46; border: 1px solid rgba(5,150,105,.25); border-radius: 999px; padding: 2px 8px; font-size: .75rem; font-weight: 600; margin-top: 6px; }
    .buy { appearance: none; text-decoration: none; background: #3b82f6; color: #fff; border: 0; border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer; white-space: nowrap; }
    .row { display: flex; gap: 10px; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; padding: 10px; border-radius: 8px; margin: 10px 0; }
    .loading { color: #6b7280; }
    @media (max-width: 720px) {
      .card { flex-direction: column; align-items: stretch; }
      .thumb { width: 100%; height: 200px; }
    }
  </style>
</head>
<body>
  <div class="row">
    <h1>Upcoming Events</h1>
    <span id="status" class="loading">Loading…</span>
  </div>
  <div id="error" class="error" style="display:none;"></div>
  <ul id="events" class="events" aria-live="polite"></ul>

  <script>
    // --- Placeholder functions (cookies removed) ---
    async function Authenticate() {
        const r = await fetch("/login", { method: "POST" });
        if (!r.ok) throw new Error("Login failed");
        return r.json(); // { session, version }
    }

    async function Content() {
        const r = await fetch("/events/upcoming");
        const payload = await r.json();
        if (!r.ok || payload?.response?.status >= 400) {
            console.error("Upcoming failed:", payload);
            throw new Error(`Upcoming failed: ${payload?.status} ${payload?.statusText || ""}`);
        }
        return payload.events;
    }
        // -------------------------------------------------

    const $status = document.getElementById("status");
    const $error  = document.getElementById("error");
    const $list   = document.getElementById("events");

    function fallbackImage(src) {
      return src && src.trim() ? src : "av.webp";
    }

    function createEventItem(event) {
      const li = document.createElement("li");
      li.className = "card";

      const img = document.createElement("img");
      img.className = "thumb";
      img.alt = event.name?.standard || "Event image";
      img.src = fallbackImage(event.image1?.standard || "");
      img.onerror = () => { img.src = "av.webp"; };

      const meta = document.createElement("div");
      meta.className = "meta";

      const h2 = document.createElement("h2");
      h2.className = "title";
      h2.textContent = event.name?.standard ?? "Untitled event";

      const p1 = document.createElement("p");
      p1.className = "muted";
      p1.textContent = "Start Date: " + (event.start_date?.display ?? "—");

      const p2 = document.createElement("p");
      p2.className = "muted";
      p2.textContent = "End Date: " + (event.end_date?.display ?? "—");

      const p3 = document.createElement("p");
      p3.className = "muted";
      p3.textContent = "Location: " + (event.city?.standard ?? "—");

      const badge = document.createElement("span");
      badge.className = "badge";
      badge.textContent = "Available Seats: " + (event.availability_num?.standard ?? "—");

      const buy = document.createElement("a");
      buy.className = "buy";
      buy.textContent = "Buy";
      buy.href = `event.html?id=${encodeURIComponent(event.id?.standard ?? "")}`;

      meta.appendChild(h2);
      meta.appendChild(p1);
      meta.appendChild(p2);
      meta.appendChild(p3);
      meta.appendChild(badge);

      li.appendChild(img);
      li.appendChild(meta);
      li.appendChild(buy);

      return li;
    }

    async function main() {
      try {
        $status.textContent = "Authorizing…";
        const auth = await Authenticate();

        $status.textContent = "Loading events…";
        const events = await Content();

        $list.innerHTML = "";
        if (!events || events.length === 0) {
          $list.insertAdjacentHTML("beforeend", `<li class="muted">No upcoming events.</li>`);
        } else {
          for (const ev of events) {
            $list.appendChild(createEventItem(ev));
          }
        }
        $status.textContent = `${events?.length ?? 0} event(s)`;
      } catch (e) {
        console.error(e);
        $error.style.display = "";
        $error.textContent = "Couldn’t load events. Please try again.";
        $status.textContent = "Error";
      }
    }

    main();
  </script>
</body>
</html>
